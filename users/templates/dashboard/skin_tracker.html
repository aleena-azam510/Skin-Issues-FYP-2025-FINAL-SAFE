{% extends "dashboard/layout.html" %}

{% block extra_css %}
<style>
/* ===== MAIN CONTAINER ===== */
.skin-tracker-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
}

/* ===== HEADER ===== */
.tracker-header {
    display: flex;
    align-items: center;
    gap: 20px;
    margin-bottom: 40px;
    padding: 25px;
    background: linear-gradient(135deg, #2A6B4E 0%, #4CAF50 100%);
    border-radius: 20px;
    color: white;
    box-shadow: 0 10px 30px rgba(42, 107, 78, 0.2);
    position: relative;
    overflow: hidden;
}

.tracker-header::before {
    content: '';
    position: absolute;
    top: -50%;
    right: -50%;
    width: 200%;
    height: 200%;
    background: radial-gradient(circle, rgba(255,255,255,0.1) 1px, transparent 1px);
    background-size: 30px 30px;
    opacity: 0.3;
    z-index: 0;
}

.header-icon {
    width: 70px;
    height: 70px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 32px;
    backdrop-filter: blur(10px);
    position: relative;
    z-index: 1;
}

.header-content {
    position: relative;
    z-index: 1;
    flex: 1;
}

.header-content h1 {
    margin: 0 0 8px 0;
    font-size: 32px;
    font-weight: 700;
    color:white;
}

.header-content p {
    margin: 0;
    opacity: 0.9;
    font-size: 16px;
}

.header-stats {
    display: flex;
    gap: 20px;
    margin-top: 15px;
}

.stat-item {
    display: flex;
    align-items: center;
    gap: 8px;
    background: rgba(255, 255, 255, 0.15);
    padding: 6px 12px;
    border-radius: 10px;
    backdrop-filter: blur(5px);
}

.stat-item i {
    font-size: 14px;
}

.stat-item span {
    font-size: 14px;
    font-weight: 500;
}

/* ===== UPLOAD SECTION ===== */
.upload-section {
    background: #fff;
    border-radius: 20px;
    padding: 30px;
    margin-bottom: 40px;
    box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
    border: 1px solid #e2e8f0;
}

.section-title {
    margin: 0 0 20px 0;
    color: #1a202c;
    font-size: 22px;
    font-weight: 700;
    display: flex;
    align-items: center;
    gap: 10px;
}

.upload-card {
    background: #f8fafc;
    border-radius: 16px;
    padding: 30px;
    border: 2px dashed #cbd5e1;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.upload-card:hover {
    border-color: #2A6B4E;
    background: linear-gradient(135deg, #f8fafc 0%, #f0fdf4 100%);
}

.file-upload-area {
    text-align: center;
    padding: 50px 20px;
    cursor: pointer;
    position: relative;
    transition: all 0.3s ease;
}

.file-upload-area:hover {
    transform: translateY(-2px);
}

.upload-icon {
    font-size: 48px;
    color: #2A6B4E;
    margin-bottom: 16px;
    transition: all 0.3s ease;
}

.file-upload-area:hover .upload-icon {
    transform: scale(1.1);
    color: #4CAF50;
}

.file-upload-area p {
    margin: 10px 0;
    color: #4a5568;
    font-size: 16px;
}

.file-types {
    color: #a0aec0;
    font-size: 14px;
    margin-top: 8px;
    background: rgba(42, 107, 78, 0.1);
    display: inline-block;
    padding: 4px 12px;
    border-radius: 20px;
}

.file-input {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    opacity: 0;
    cursor: pointer;
}

/* ===== PREVIEW ===== */
.preview-container {
    margin-top: 20px;
    text-align: center;
    animation: fadeIn 0.5s ease;
}

.preview-image {
    max-width: 100%;
    max-height: 300px;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    border: 3px solid white;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

/* ===== BUTTONS ===== */
.action-buttons {
    display: flex;
    gap: 15px;
    margin-top: 25px;
    justify-content: center;
}

.upload-btn {
    padding: 14px 32px;
    background: linear-gradient(135deg, #2A6B4E 0%, #4CAF50 100%);
    color: white;
    border: none;
    border-radius: 12px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 10px;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(42, 107, 78, 0.3);
    position: relative;
    overflow: hidden;
}

.upload-btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
    transition: 0.5s;
}

.upload-btn:hover::before {
    left: 100%;
}

.upload-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(42, 107, 78, 0.4);
}

.upload-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none !important;
}

.clear-btn {
    padding: 14px 32px;
    background: #fff;
    color: #4a5568;
    border: 2px solid #e2e8f0;
    border-radius: 12px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 8px;
}

.clear-btn:hover {
    background: #f7fafc;
    border-color: #cbd5e1;
    transform: translateY(-2px);
}

/* ===== RESULTS SECTION ===== */
.result-section {
    background: #fff;
    border-radius: 20px;
    padding: 30px;
    margin: 30px 0;
    box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
    border: 1px solid #e2e8f0;
    animation: slideDown 0.5s ease;
}

@keyframes slideDown {
    from { opacity: 0; transform: translateY(-20px); }
    to { opacity: 1; transform: translateY(0); }
}

.result-header {
    display: flex;
    align-items: center;
    gap: 15px;
    margin-bottom: 25px;
    padding-bottom: 15px;
    border-bottom: 2px solid #f7fafc;
}

.result-header i {
    color: #2A6B4E;
    font-size: 24px;
    background: rgba(42, 107, 78, 0.1);
    width: 50px;
    height: 50px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 12px;
}

.result-header h3 {
    margin: 0;
    color: #1a202c;
    font-size: 24px;
    font-weight: 700;
    flex: 1;
}

.clear-results-btn {
    padding: 8px 16px;
    background: linear-gradient(135deg, #fed7d7 0%, #feb2b2 100%);
    color: #c53030;
    border: none;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: all 0.3s ease;
}

.clear-results-btn:hover {
    background: linear-gradient(135deg, #feb2b2 0%, #fc8181 100%);
    transform: translateY(-1px);
}

.result-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.result-card {
    background: #f8fafc;
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    transition: all 0.3s ease;
    border: 1px solid #e2e8f0;
    position: relative;
    overflow: hidden;
}

.result-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 4px;
    height: 100%;
    background: linear-gradient(to bottom, #2A6B4E, #4CAF50);
}

.result-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
}

.result-card h4 {
    margin: 0 0 10px 0;
    color: #2d3748;
    font-size: 16px;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 8px;
}

.confidence-score {
    font-size: 28px;
    font-weight: 700;
    color: #2A6B4E;
    margin: 10px 0;
    position: relative;
    display: inline-block;
}

.confidence-score::after {
    content: '';
    position: absolute;
    bottom: -5px;
    left: 0;
    width: 100%;
    height: 3px;
    background: linear-gradient(90deg, #2A6B4E, #4CAF50);
    border-radius: 2px;
}

.improvement-badge {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    padding: 4px 12px;
    background: #c6f6d5;
    color: #22543d;
    border-radius: 20px;
    font-size: 14px;
    font-weight: 600;
    margin-top: 10px;
}

.improvement-badge.negative {
    background: linear-gradient(135deg, #fed7d7 0%, #feb2b2 100%);
    color: #742a2a;
}

.improvement-badge.neutral {
    background: linear-gradient(135deg, #e2e8f0 0%, #cbd5e1 100%);
    color: #4a5568;
}

.improvement-badge.positive {
    background: linear-gradient(135deg, #c6f6d5 0%, #9ae6b4 100%);
    color: #22543d;
}

.condition-tag {
    display: inline-block;
    padding: 4px 12px;
    background: rgba(42, 107, 78, 0.1);
    color: #22543d;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 500;
    margin: 2px;
    border: 1px solid rgba(42, 107, 78, 0.2);
}

.analyzed-image-container {
    text-align: center;
    margin-top: 30px;
    padding-top: 20px;
    border-top: 2px solid #f7fafc;
}

.analyzed-image-container h4 {
    margin: 0 0 15px 0;
    color: #2d3748;
    font-size: 18px;
    font-weight: 600;
}

.analyzed-image {
    max-width: 300px;
    border-radius: 12px;
    margin: 0 auto;
    display: block;
    cursor: pointer;
    border: 3px solid white;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    transition: all 0.3s ease;
}

.analyzed-image:hover {
    transform: scale(1.02);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
}

/* ===== HISTORY SECTION ===== */
.history-section {
    background: #fff;
    border-radius: 20px;
    padding: 30px;
    box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
    border: 1px solid #e2e8f0;
}

.history-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 25px;
    margin-top: 20px;
}

.history-card {
    background: white;
    border-radius: 16px;
    overflow: hidden;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    transition: all 0.3s ease;
    border: 1px solid #e2e8f0;
    position: relative;
}

.history-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
}

.history-image {
    width: 100%;
    height: 180px;
    object-fit: cover;
    cursor: pointer;
    transition: all 0.3s ease;
}

.history-image:hover {
    transform: scale(1.05);
}

.card-content {
    padding: 20px;
}

.card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}

.card-date {
    color: #718096;
    font-size: 14px;
    font-weight: 500;
    background: #f7fafc;
    padding: 4px 10px;
    border-radius: 20px;
}

.confidence-badge {
    padding: 4px 12px;
    background: rgba(42, 107, 78, 0.1);
    color: #22543d;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
}

.card-conditions {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    margin-bottom: 15px;
    min-height: 28px;
}

.condition-tag {
    padding: 3px 10px;
    background: rgba(42, 107, 78, 0.1);
    color: #22543d;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 500;
}

.improvement-display {
    margin: 12px 0;
    padding: 10px;
    background: linear-gradient(135deg, #f0fff4 0%, #e6fffa 100%);
    border-radius: 10px;
    border: 1px solid #c6f6d5;
}

.improvement-display.negative {
    background: linear-gradient(135deg, #fff5f5 0%, #fed7d7 100%);
    border: 1px solid #fed7d7;
}

.improvement-display.neutral {
    background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
    border: 1px solid #e2e8f0;
}

.improvement-score {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 4px;
}

.improvement-label {
    color: #22543d;
    font-size: 13px;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 5px;
}

.improvement-value {
    color: #22543d;
    font-weight: bold;
    font-size: 16px;
}

.improvement-value.positive {
    color: #276749;
}

.improvement-value.negative {
    color: #c53030;
}

.improvement-value.neutral {
    color: #4a5568;
}

.improvement-trend {
    font-size: 12px;
    color: #475569;
    line-height: 1.4;
}

.card-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-top: 15px;
    border-top: 1px solid #e2e8f0;
    margin-top: 10px;
}

.delete-btn {
    padding: 8px 16px;
    background: linear-gradient(135deg, #fed7d7 0%, #feb2b2 100%);
    color: #c53030;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: 6px;
    transition: all 0.3s ease;
}

.delete-btn:hover {
    background: linear-gradient(135deg, #feb2b2 0%, #fc8181 100%);
    transform: translateY(-2px);
    box-shadow: 0 2px 8px rgba(197, 48, 48, 0.2);
}

.no-history {
    text-align: center;
    padding: 60px 20px;
    color: #718096;
    grid-column: 1 / -1;
}

.no-history i {
    font-size: 64px;
    margin-bottom: 20px;
    color: #cbd5e1;
    opacity: 0.5;
}

.no-history p {
    margin: 10px 0;
    font-size: 16px;
}

/* ===== MODAL ===== */
.image-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.95);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 9999;
    padding: 20px;
    animation: fadeInModal 0.3s ease;
}

@keyframes fadeInModal {
    from { opacity: 0; }
    to { opacity: 1; }
}

.image-modal.active {
    display: flex;
}

.modal-content {
    position: relative;
    max-width: 90%;
    max-height: 90%;
    animation: scaleIn 0.3s ease;
}

@keyframes scaleIn {
    from { transform: scale(0.9); opacity: 0; }
    to { transform: scale(1); opacity: 1; }
}

.modal-content img {
    max-width: 100%;
    max-height: 80vh;
    border-radius: 12px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    border: 2px solid rgba(255, 255, 255, 0.1);
}

.close-modal {
    position: absolute;
    top: -50px;
    right: 0;
    background: rgba(255, 255, 255, 0.1);
    border: none;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    color: white;
    transition: all 0.3s ease;
    backdrop-filter: blur(10px);
}

.close-modal:hover {
    background: rgba(255, 255, 255, 0.2);
    transform: rotate(90deg);
}

/* ===== LOADING ===== */
.loading-spinner {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid rgba(255, 255, 255, 0.3);
    border-radius: 50%;
    border-top-color: white;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

.loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 10000;
    flex-direction: column;
    gap: 20px;
}

.loading-overlay.active {
    display: flex;
}

.loading-text {
    color: white;
    font-size: 18px;
    font-weight: 500;
}

/* ===== RESPONSIVE ===== */
@media (max-width: 768px) {
    .tracker-header {
        flex-direction: column;
        text-align: center;
        padding: 20px;
    }
    
    .header-icon {
        width: 60px;
        height: 60px;
        font-size: 28px;
    }
    
    .header-stats {
        flex-direction: column;
        gap: 10px;
        align-items: center;
    }
    
    .action-buttons {
        flex-direction: column;
    }
    
    .history-grid {
        grid-template-columns: 1fr;
    }
    
    .result-grid {
        grid-template-columns: 1fr;
    }
}

/* ===== TOAST NOTIFICATION ===== */
.toast-container {
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 10001;
}

.toast {
    min-width: 300px;
    background: white;
    border-radius: 12px;
    padding: 16px 20px;
    margin-top: 10px;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
    display: flex;
    align-items: center;
    gap: 12px;
    animation: toastSlideIn 0.3s ease;
    border-left: 4px solid;
}

.toast.success {
    border-left-color: #38a169;
}

.toast.error {
    border-left-color: #e53e3e;
}

.toast.info {
    border-left-color: #3182ce;
}

.toast.warning {
    border-left-color: #f59e0b;
}

.toast-icon {
    font-size: 20px;
}

.toast.success .toast-icon {
    color: #38a169;
}

.toast.error .toast-icon {
    color: #e53e3e;
}

.toast.info .toast-icon {
    color: #3182ce;
}

.toast.warning .toast-icon {
    color: #f59e0b;
}

.toast-content {
    flex: 1;
}

.toast-title {
    font-weight: 600;
    color: #2d3748;
    margin-bottom: 4px;
}

.toast-message {
    color: #718096;
    font-size: 14px;
}

.toast-close {
    background: none;
    border: none;
    color: #a0aec0;
    cursor: pointer;
    padding: 4px;
    border-radius: 6px;
    transition: all 0.3s ease;
}

.toast-close:hover {
    background: #f7fafc;
    color: #718096;
}

@keyframes toastSlideIn {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}

@keyframes toastSlideOut {
    from { transform: translateX(0); opacity: 1; }
    to { transform: translateX(100%); opacity: 0; }
}

/* ===== DELETE BUTTON FIXES ===== */
.delete-btn.loading {
    opacity: 0.7;
    cursor: not-allowed;
}

.delete-btn.loading i {
    animation: spin 1s linear infinite;
}

/* ===== ORANGE ACCENTS ===== */
.orange-accent {
    color: #f59e0b;
}

.orange-gradient {
    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
}

.orange-bg {
    background: rgba(245, 158, 11, 0.1);
}

.orange-border {
    border-color: #f59e0b;
}

/* ===== ANALYZED IMAGE ORANGE BORDER ===== */
.analyzed-image.orange-border {
    border: 3px solid #f59e0b;
}

/* ===== HISTORY CARD ORANGE BORDER ON HOVER ===== */
.history-card:hover {
    border-color: #f59e0b;
}

/* ===== RESULT CARD ORANGE ACCENT ===== */
.result-card.orange-accent::before {
    background: linear-gradient(to bottom, #f59e0b, #d97706);
}

/* ===== UPLOAD BUTTON ORANGE VARIANT ===== */
.upload-btn.orange {
    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    box-shadow: 0 4px 15px rgba(245, 158, 11, 0.3);
}

.upload-btn.orange:hover {
    box-shadow: 0 6px 20px rgba(245, 158, 11, 0.4);
}
.delete-all-btn {
    background: #e53e3e;
    color: #fff;
    border: none;
    padding: 10px 16px;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    transition: 0.2s ease;
}

.delete-all-btn:hover {
    background: #c53030;
}

</style>
{% endblock %}

{% block dashboard_content %}
<div class="skin-tracker-container">
    <!-- Header -->
    <div class="tracker-header">
        <div class="header-icon">
            <i class="fas fa-chart-line"></i>
        </div>
        <div class="header-content">
            <h1>Skin Progress Tracker</h1>
            <p>Monitor your skin health with AI-powered analysis</p>
            <div class="header-stats">
                <div class="stat-item">
                    <i class="fas fa-images"></i>
                    <span>{{ uploads|length }} Analyses</span>
                </div>
                <div class="stat-item">
                    <i class="fas fa-trend-up"></i>
                    <span>{{ latest_result.improvement|default:"0" }}% Avg Improvement</span>
                </div>
                <div class="stat-item">
                    <i class="fas fa-check-circle"></i>
                    <span>{{ uploads|length }}% Accuracy</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Upload Section -->
    <div class="upload-section">
        <h2 class="section-title">
            <i class="fas fa-upload"></i>
            Upload New Analysis
        </h2>
        <div class="upload-card">
            <form id="uploadForm" method="POST" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="file-upload-area" id="dropZone">
                    <div class="upload-icon">
                        <i class="fas fa-cloud-upload-alt"></i>
                    </div>
                    <p><strong>Drag & Drop your skin photo here</strong></p>
                    <p>or click to browse files</p>
                    <p class="file-types">JPG, PNG, WEBP • Max 10MB</p>
                    <input type="file" name="image" accept="image/*" class="file-input" id="fileInput" required>
                </div>
                
                <div id="previewContainer" class="preview-container"></div>
                
                <div class="action-buttons">
                    <button type="submit" class="upload-btn" id="uploadBtn">
                        <span id="btnText">Analyze Skin</span>
                        <div id="btnSpinner" class="loading-spinner" style="display: none;"></div>
                        <i class="fas fa-search" id="btnIcon"></i>
                    </button>
                    <button type="button" class="clear-btn" id="clearBtn">
                        <i class="fas fa-times"></i> Clear
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Results Section -->
    <div id="resultSection" class="result-section" {% if not latest_result %}style="display: none;"{% endif %}>
        <div class="result-header">
            <i class="fas fa-chart-bar"></i>
            <h3>Latest Analysis Results</h3>
            <button class="clear-results-btn" onclick="clearResults()">
                <i class="fas fa-times"></i> Clear Results
            </button>
        </div>
        <div id="resultContent">
            {% if latest_result %}
            <!-- Server-side rendered latest result -->
            <div class="result-grid">
                <div class="result-card">
                    <h4><i class="fas fa-stethoscope"></i> Detected Conditions</h4>
                    <div style="margin-top: 10px;">
                        {% for condition in latest_result.conditions %}
                            <span class="condition-tag">{{ condition }}</span>
                        {% empty %}
                            <p style="color: #718096; font-style: italic; font-size: 14px;">No specific conditions detected</p>
                        {% endfor %}
                    </div>
                </div>
                
                <div class="result-card">
                    <h4><i class="fas fa-chart-line"></i> Confidence Score</h4>
                    <div class="confidence-score">{{ latest_result.confidence }}%</div>
                    <p style="color: #718096; font-size: 14px; margin-top: 8px;">
                        {% if latest_result.confidence > 70 %}
                            High confidence in analysis
                        {% elif latest_result.confidence > 40 %}
                            Moderate confidence in analysis
                        {% else %}
                            Low confidence - consider retaking photo
                        {% endif %}
                    </p>
                </div>
                
                <div class="result-card">
                    <h4><i class="fas fa-trend-up"></i> Improvement</h4>
                    <div class="confidence-score">{{ latest_result.improvement }}%</div>
                    {% if latest_result.improvement > 0 %}
                        <div class="improvement-badge">
                            <i class="fas fa-arrow-up"></i> Positive Progress
                        </div>
                    {% elif latest_result.improvement < 0 %}
                        <div class="improvement-badge negative">
                            <i class="fas fa-arrow-down"></i> Needs Attention
                        </div>
                    {% else %}
                        <div class="improvement-badge neutral">
                            <i class="fas fa-minus"></i> Stable Condition
                        </div>
                    {% endif %}
                </div>
                
                <div class="result-card">
                    <h4><i class="far fa-calendar"></i> Analysis Date</h4>
                    <div style="font-size: 18px; font-weight: 600; color: #4a5568; margin: 10px 0;">{{ latest_result.date }}</div>
                    <p style="color: #718096; font-size: 14px;">
                        <i class="far fa-clock"></i> Last updated
                    </p>
                </div>
            </div>
            
            <div class="analyzed-image-container">
                <h4><i class="fas fa-image"></i> Analyzed Image</h4>
                <img src="{{ latest_result.image_url }}" 
                     alt="Analyzed skin" 
                     class="analyzed-image"
                     onclick="previewImage('{{ latest_result.image_url }}')">
                <p style="color: #a0aec0; font-size: 14px; margin-top: 10px;">
                    Click image to enlarge • Results are saved to history
                </p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- History Section -->
    <div class="history-section">
        <h2 class="section-title">
            <i class="fas fa-history"></i>
            Analysis History
        </h2>
        {% if uploads %}
            <div style="text-align: right; margin-bottom: 15px;">
                <button id="deleteAllBtn" class="delete-all-btn">
                    <i class="fas fa-trash-alt"></i> Delete All History
                </button>
            </div>
            {% endif %}

        <div class="history-grid" id="historyGrid">
            {% for u in uploads %}
            <div class="history-card" id="card-{{ u.id }}">
                <img src="{{ u.image.url }}" alt="Skin analysis {{ forloop.counter }}" 
                     class="history-image"
                     onclick="previewImage('{{ u.image.url }}')">
                <div class="card-content">
                    <div class="card-header">
                        <span class="card-date">{{ u.created_at|date:"M d, Y" }}</span>
                        <span class="confidence-badge">{{ u.ai_confidence|floatformat:1 }}%</span>
                    </div>
                    
                    <div class="card-conditions">
                        {% with conditions=u.detection_result.split|slice:":4" %}
                            {% for condition in conditions %}
                                <span class="condition-tag">{{ condition }}</span>
                            {% endfor %}
                            {% if u.detection_result.split|length > 4 %}
                                <span class="condition-tag">+{{ u.detection_result.split|length|add:"-4" }}</span>
                            {% endif %}
                        {% endwith %}
                    </div>
                    
                    <!-- IMPROVEMENT DISPLAY -->
                    <!-- In the history section, update the improvement display -->
{% if u.improvement_score %}
<div class="improvement-display {% if u.improvement_score > 0 %}positive{% elif u.improvement_score < 0 %}negative{% else %}neutral{% endif %}">
    <div class="improvement-score">
        <span class="improvement-label">
            <i class="fas fa-chart-line"></i> Improvement
        </span>
        <span class="improvement-value {% if u.improvement_score > 0 %}positive{% elif u.improvement_score < 0 %}negative{% else %}neutral{% endif %}">
            {{ u.improvement_score }}%
        </span>
    </div>
    {% if u.improvement_trend %}
    <div class="improvement-trend">
        {{ u.improvement_trend }}
    </div>
    {% endif %}
</div>
{% endif %}
                    
                    <div class="card-footer">
                        <small style="color: #a0aec0; font-size: 12px;">{{ u.created_at|date:"g:i A" }}</small>
                        <button class="delete-btn" data-id="{{ u.id }}">
                            <i class="fas fa-trash"></i>
                            Delete
                        </button>
                    </div>
                </div>
            </div>
            {% empty %}
            <div class="no-history">
                <i class="fas fa-images"></i>
                <p>No skin analyses yet</p>
                <p style="color: #a0aec0; font-size: 14px;">Upload your first photo to start tracking progress</p>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Image Modal -->
<div id="imageModal" class="image-modal">
    <div class="modal-content">
        <button class="close-modal" onclick="closeModal()">
            <i class="fas fa-times"></i>
        </button>
        <img id="modalImage" src="" alt="Enlarged view">
    </div>
</div>

<!-- Loading Overlay -->
<div id="loadingOverlay" class="loading-overlay">
    <div class="loading-spinner" style="width: 60px; height: 60px; border-width: 4px;"></div>
    <div class="loading-text">Analyzing your skin...</div>
</div>

<!-- Toast Container -->
<div class="toast-container"></div>
{% endblock %}

{% block dashboard_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // ===============================
    // DOM Elements
    // ===============================
    const fileInput = document.getElementById('fileInput');
    const previewContainer = document.getElementById('previewContainer');
    const dropZone = document.getElementById('dropZone');
    const uploadForm = document.getElementById('uploadForm');
    const uploadBtn = document.getElementById('uploadBtn');
    const btnText = document.getElementById('btnText');
    const btnSpinner = document.getElementById('btnSpinner');
    const btnIcon = document.getElementById('btnIcon');
    const clearBtn = document.getElementById('clearBtn');
    const resultSection = document.getElementById('resultSection');
    const resultContent = document.getElementById('resultContent');
    const historyGrid = document.getElementById('historyGrid');
    const loadingOverlay = document.getElementById('loadingOverlay');
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    
    // Store for file clearing
    let currentFile = null;

    // ===============================
    // File Preview Function
    // ===============================
    fileInput.addEventListener('change', handleFileSelect);
    
    function handleFileSelect() {
        const file = fileInput.files[0];
        if (!file) return;
        
        currentFile = file;
        
        // Validate file size (5MB)
        if (file.size > 10 * 1024 * 1024) {
            showToast('File size must be less than 10MB', 'error');
            fileInput.value = '';
            currentFile = null;
            return;
        }
        
        // Validate file type
        const validTypes = ['image/jpeg', 'image/png', 'image/webp', 'image/jpg'];
        if (!validTypes.includes(file.type)) {
            showToast('Please upload a valid image file (JPG, PNG, WEBP)', 'error');
            fileInput.value = '';
            currentFile = null;
            return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
            previewContainer.innerHTML = `
                <img src="${e.target.result}" class="preview-image" alt="Preview">
                <div style="margin-top: 10px; color: #4a5568;">
                    <i class="fas fa-check-circle" style="color: #38a169;"></i>
                    ${file.name} • ${(file.size / 1024).toFixed(0)}KB
                </div>
            `;
            uploadBtn.disabled = false;
        };
        reader.readAsDataURL(file);
    }

    // ===============================
    // Clear Button Functionality
    // ===============================
    clearBtn.addEventListener('click', function() {
        // Clear file input
        fileInput.value = '';
        currentFile = null;
        
        // Clear preview
        previewContainer.innerHTML = '';
        
        // Clear results section
        resultSection.style.display = 'none';
        resultContent.innerHTML = '';
        
        // Remove from localStorage
        localStorage.removeItem('latestSkinAnalysis');
        
        // Reset button
        uploadBtn.disabled = false;
        btnText.textContent = 'Analyze Skin';
        btnIcon.style.display = 'inline-block';
        btnSpinner.style.display = 'none';
        
        showToast('All cleared successfully', 'info');
    });

    // ===============================
    // Drag & Drop
    // ===============================
    dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.style.borderColor = '#2A6B4E';
        dropZone.style.background = 'linear-gradient(135deg, #f8fafc 0%, #f0fdf4 100%)';
    });

    dropZone.addEventListener('dragleave', () => {
        dropZone.style.borderColor = '#cbd5e1';
        dropZone.style.background = '#f8fafc';
    });

    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.style.borderColor = '#cbd5e1';
        dropZone.style.background = '#f8fafc';
        
        if (e.dataTransfer.files.length) {
            fileInput.files = e.dataTransfer.files;
            handleFileSelect();
        }
    });

    // ===============================
// CLEAN & WORKING DELETE HANDLER
// ===============================
document.addEventListener('click', function (e) {
    const btn = e.target.closest('.delete-btn');
    if (!btn) return;

    const id = btn.dataset.id;
    const card = document.getElementById(`card-${id}`);

    if (!confirm('Are you sure you want to delete this analysis?')) return;

    btn.disabled = true;
    const originalHTML = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Deleting...';

    fetch(`/dashboard/tracker/delete/${id}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken,
            'X-Requested-With': 'XMLHttpRequest'
        },
        credentials: 'same-origin'
    })
    .then(res => {
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        return res.json();
    })
    .then(data => {
        if (!data.success) throw new Error(data.error || 'Delete failed');

        // Smooth remove
        card.style.transition = '0.3s ease';
        card.style.opacity = '0';
        card.style.transform = 'translateX(40px)';

        setTimeout(() => {
            card.remove();
            showToast('Analysis deleted successfully', 'success');

            if (!document.querySelector('.history-card')) {
                historyGrid.innerHTML = `
                    <div class="no-history">
                        <i class="fas fa-images"></i>
                        <p>No skin analyses yet</p>
                    </div>
                `;
            }
        }, 300);
    })
    .catch(err => {
        console.error(err);
        showToast('Failed to delete analysis', 'error');
        btn.innerHTML = originalHTML;
        btn.disabled = false;
    });
});
// ===============================
// DELETE ALL HISTORY
// ===============================
const deleteAllBtn = document.getElementById('deleteAllBtn');

if (deleteAllBtn) {
    deleteAllBtn.addEventListener('click', async () => {
        if (!confirm('⚠️ This will permanently delete ALL history. Continue?')) return;

        deleteAllBtn.disabled = true;
        deleteAllBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Deleting...';

        try {
            const res = await fetch('/dashboard/tracker/delete-all/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'X-Requested-With': 'XMLHttpRequest'
                },
                credentials: 'same-origin'
            });

            if (!res.ok) throw new Error('Failed');

            const data = await res.json();
            if (!data.success) throw new Error(data.error);

            // Clear UI
            historyGrid.innerHTML = `
                <div class="no-history">
                    <i class="fas fa-images"></i>
                    <p>No skin analyses yet</p>
                </div>
            `;

            showToast('All history deleted successfully', 'success');

        } catch (err) {
            console.error(err);
            showToast('Failed to delete all history', 'error');
            deleteAllBtn.disabled = false;
            deleteAllBtn.innerHTML = '<i class="fas fa-trash-alt"></i> Delete All History';
        }
    });
}


    // ===============================
    // DEBUG: Test Delete Endpoint Function
    // ===============================
    window.testDeleteEndpoint = async function(id) {
        console.log('Testing delete endpoint for ID:', id);
        
        const formData = new FormData();
        formData.append('csrfmiddlewaretoken', csrfToken);
        
        try {
            const response = await fetch(`/delete-skin-image/${id}/`, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': csrfToken
                }
            });
            
            console.log('Response status:', response.status);
            console.log('Response headers:', Object.fromEntries(response.headers.entries()));
            
            const text = await response.text();
            console.log('Raw response:', text);
            
            try {
                const json = JSON.parse(text);
                console.log('Parsed JSON:', json);
                return json;
            } catch (e) {
                console.log('Not JSON, text is:', text.substring(0, 200));
                return { success: false, error: 'Not JSON', text: text.substring(0, 200) };
            }
            
        } catch (error) {
            console.error('Test error:', error);
            return { success: false, error: error.message };
        }
    };

    // ===============================
    // Fixed Upload Function
    // ===============================
    uploadForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        if (!fileInput.files[0]) {
            showToast('Please select an image to analyze', 'error');
            return;
        }
        
        const file = fileInput.files[0];
        
        // Validate file
        if (file.size > 10 * 1024 * 1024) {
            showToast('File size must be less than 10MB', 'error');
            return;
        }
        
        // Show loading overlay
        loadingOverlay.classList.add('active');
        
        // Update button state
        uploadBtn.disabled = true;
        btnText.textContent = 'Analyzing...';
        btnIcon.style.display = 'none';
        btnSpinner.style.display = 'inline-block';
        
        // Show results section with loading
        resultSection.style.display = 'block';
        resultContent.innerHTML = `
            <div style="text-align: center; padding: 40px;">
                <div class="loading-spinner" style="width: 40px; height: 40px; margin: 0 auto 20px; border-width: 4px; border-color: #2A6B4E; border-top-color: white;"></div>
                <p style="color: #4a5568; font-size: 16px;">AI is analyzing your skin image...</p>
                <div style="margin-top: 20px; color: #718096; font-size: 14px; max-width: 400px; margin: 20px auto;">
                    <div style="display: flex; align-items: center; gap: 10px; margin: 8px 0;">
                        <i class="fas fa-check-circle" style="color: #38a169;"></i>
                        <span>Detecting skin conditions</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 10px; margin: 8px 0;">
                        <i class="fas fa-spinner fa-spin" style="color: #2A6B4E;"></i>
                        <span>Calculating confidence scores</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 10px; margin: 8px 0;">
                        <i class="fas fa-hourglass-half" style="color: #f59e0b;"></i>
                        <span>Tracking improvements</span>
                    </div>
                </div>
            </div>
        `;
        
        const formData = new FormData(uploadForm);
        
        try {
            const response = await fetch('', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': csrfToken
                }
            });
            
            // Hide loading overlay
            loadingOverlay.classList.remove('active');
            
            // Check if response is okay
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            // Try to parse JSON
            let data;
            try {
                const text = await response.text();
                if (!text.trim()) {
                    throw new Error('Empty response from server');
                }
                data = JSON.parse(text);
            } catch (parseError) {
                console.error('JSON parse error:', parseError);
                throw new Error('Server returned invalid response. Please try again.');
            }
            
            if (data.status === 'success') {
                displayResults(data.data);
                showToast('Analysis completed successfully!', 'success');
                
                // Clear file input and preview
                fileInput.value = '';
                previewContainer.innerHTML = '';
                currentFile = null;
                
                // Reload the page after 1.5 seconds to show updated history
                setTimeout(() => {
                    window.location.reload();
                }, 1500);
                
            } else {
                throw new Error(data.message || 'Analysis failed');
            }
            
        } catch (error) {
            console.error('Upload error:', error);
            loadingOverlay.classList.remove('active');
            
            let errorMessage = error.message;
            if (error.message.includes('invalid response')) {
                errorMessage = 'Server error. The analysis could not be processed.';
            } else if (error.message.includes('HTTP error')) {
                errorMessage = 'Network error. Please check your connection and try again.';
            }
            
            resultContent.innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <div style="color: #e53e3e; font-size: 48px; margin-bottom: 20px;">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <h4 style="color: #c53030; margin-bottom: 10px;">Analysis Failed</h4>
                    <p style="color: #718096; margin-bottom: 20px;">${errorMessage}</p>
                    <div style="display: flex; gap: 10px; justify-content: center;">
                        <button onclick="retryUpload()" class="upload-btn" style="padding: 10px 20px;">
                            <i class="fas fa-redo"></i> Try Again
                        </button>
                        <button onclick="clearResults()" class="clear-btn" style="padding: 10px 20px;">
                            <i class="fas fa-times"></i> Clear
                        </button>
                    </div>
                </div>
            `;
            showToast(errorMessage, 'error');
            
        } finally {
            // Reset button state
            uploadBtn.disabled = false;
            btnText.textContent = 'Analyze Skin';
            btnIcon.style.display = 'inline-block';
            btnSpinner.style.display = 'none';
        }
    });

    // ===============================
    // Display Results Function with Orange Accents
    // ===============================
    function displayResults(data) {
        const conditions = Array.isArray(data.conditions) ? data.conditions : 
                          (data.conditions ? data.conditions.split(', ') : []);
        
        // Store in localStorage
        localStorage.setItem('latestSkinAnalysis', JSON.stringify(data));
        
        // Determine if improvement is positive, negative, or neutral
        const improvement = parseFloat(data.improvement || 0);
        const improvementClass = improvement > 0 ? 'positive' : improvement < 0 ? 'negative' : 'neutral';
        const improvementColor = improvement > 0 ? '#38a169' : improvement < 0 ? '#e53e3e' : '#f59e0b';
        
        resultContent.innerHTML = `
            <div class="result-grid">
                <div class="result-card">
                    <h4><i class="fas fa-stethoscope"></i> Detected Conditions</h4>
                    <div style="margin-top: 10px; min-height: 40px;">
                        ${conditions.length > 0 ? 
                            conditions.map(cond => 
                                `<span class="condition-tag">${cond}</span>`
                            ).join('') : 
                            '<p style="color: #718096; font-style: italic; font-size: 14px;">No specific conditions detected</p>'
                        }
                    </div>
                </div>
                
                <div class="result-card">
                    <h4><i class="fas fa-chart-line"></i> Confidence Score</h4>
                    <div class="confidence-score">${data.confidence ? parseFloat(data.confidence).toFixed(1) : '0'}%</div>
                    <div style="margin-top: 10px; height: 8px; background: #e2e8f0; border-radius: 4px; overflow: hidden;">
                        <div style="height: 100%; width: ${Math.min(data.confidence || 0, 100)}%; background: linear-gradient(90deg, #2A6B4E, #4CAF50); border-radius: 4px;"></div>
                    </div>
                    <p style="color: #718096; font-size: 14px; margin-top: 8px;">
                        ${data.confidence > 70 ? 'High confidence in analysis' : 
                          data.confidence > 40 ? 'Moderate confidence in analysis' : 
                          'Low confidence - consider retaking photo'}
                    </p>
                </div>
                
                <div class="result-card orange-accent">
                    <h4><i class="fas fa-trend-up"></i> Improvement</h4>
                    <div class="confidence-score" style="color: ${improvementColor}">
                        ${data.improvement || 0}%
                    </div>
                    ${improvement > 0 ? 
                        '<div class="improvement-badge positive"><i class="fas fa-arrow-up"></i> Positive Progress</div>' :
                        improvement < 0 ? 
                        '<div class="improvement-badge negative"><i class="fas fa-arrow-down"></i> Needs Attention</div>' :
                        '<div class="improvement-badge neutral"><i class="fas fa-minus"></i> Stable Condition</div>'
                    }
                </div>
                
                <div class="result-card">
                    <h4><i class="far fa-calendar"></i> Analysis Date</h4>
                    <div style="font-size: 18px; font-weight: 600; color: #4a5568; margin: 10px 0;">${data.date || new Date().toLocaleDateString()}</div>
                    <p style="color: #718096; font-size: 14px;">
                        <i class="far fa-clock"></i> ${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                    </p>
                </div>
            </div>
            
            <div class="analyzed-image-container">
                <h4><i class="fas fa-image orange-accent"></i> Analyzed Image</h4>
                <img src="${data.image_url}" 
                     alt="Analyzed skin" 
                     class="analyzed-image orange-border"
                     onclick="previewImage('${data.image_url}')">
                <p style="color: #a0aec0; font-size: 14px; margin-top: 10px;">
                    <i class="fas fa-info-circle orange-accent"></i> Click image to enlarge • Results are saved to history
                </p>
            </div>
        `;
    }

    // ===============================
    // Global Helper Functions
    // ===============================
    window.clearResults = function() {
        resultSection.style.display = 'none';
        resultContent.innerHTML = '';
        localStorage.removeItem('latestSkinAnalysis');
        showToast('Results cleared', 'info');
    };

    window.retryUpload = function() {
        fileInput.click();
    };

    window.previewImage = function(url) {
        document.getElementById('modalImage').src = url;
        document.getElementById('imageModal').classList.add('active');
        document.body.style.overflow = 'hidden';
    };

    window.closeModal = function() {
        document.getElementById('imageModal').classList.remove('active');
        document.body.style.overflow = '';
    };

    // ===============================
    // Toast Notification System
    // ===============================
    function showToast(message, type = 'info') {
        const container = document.querySelector('.toast-container');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        
        const icons = {
            'success': 'fa-check-circle',
            'error': 'fa-exclamation-circle',
            'info': 'fa-info-circle',
            'warning': 'fa-exclamation-triangle'
        };
        
        const titles = {
            'success': 'Success',
            'error': 'Error',
            'info': 'Information',
            'warning': 'Warning'
        };
        
        toast.innerHTML = `
            <div class="toast-icon">
                <i class="fas ${icons[type]}"></i>
            </div>
            <div class="toast-content">
                <div class="toast-title">${titles[type]}</div>
                <div class="toast-message">${message}</div>
            </div>
            <button class="toast-close" onclick="this.parentElement.remove()">
                <i class="fas fa-times"></i>
            </button>
        `;
        
        container.appendChild(toast);
        
        // Auto-remove after 5 seconds
        setTimeout(() => {
            if (toast.parentElement) {
                toast.style.animation = 'toastSlideOut 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }
        }, 5000);
    }

    // ===============================
    // Event Listeners for Modal
    // ===============================
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') closeModal();
    });

    document.getElementById('imageModal').addEventListener('click', function(e) {
        if (e.target === this) closeModal();
    });

    // ===============================
    // Check for saved results on page load
    // ===============================
    const savedAnalysis = localStorage.getItem('latestSkinAnalysis');
    if (savedAnalysis && !document.querySelector('#resultSection .result-card')) {
        try {
            const data = JSON.parse(savedAnalysis);
            resultSection.style.display = 'block';
            displayResults(data);
        } catch (e) {
            console.error('Error loading saved analysis:', e);
        }
    }
});
</script>
{% endblock %}