<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Review Report - {{ report.user.username }}</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
    body { font-family: 'Segoe UI', sans-serif; background:#f8fafc; color:#1e293b; padding-top:20px; }
    .container { max-width: 900px; }
    .header-section { background: linear-gradient(135deg, #416931, #077531); color:white; border-radius:1rem; padding:2rem; margin-bottom:2rem; }
    .report-card { background:white; border-radius:1rem; padding:2rem; margin-bottom:2rem; box-shadow:0 10px 25px rgba(0,0,0,0.1); }
    .info-grid { display:grid; grid-template-columns:repeat(auto-fit, minmax(250px,1fr)); gap:1.5rem; margin-bottom:2rem; }
    .info-box { background:#dcfedb; border-left:4px solid #416931; border-radius:0.5rem; padding:1.25rem; }
    .info-box h5 { color:#077531; font-weight:600; margin-bottom:0.5rem; }
    .info-box p { margin-bottom:0; font-size:1.1rem; }
    .detection-box { background:#f8fafc; border-radius:0.75rem; padding:1.5rem; margin-bottom:1.5rem; border:1px solid #e2e8f0; }
    .detection-box h5 { color:#416931; margin-bottom:0.75rem; }
    .confidence-bar { flex-grow:1; height:12px; background:#e2e8f0; border-radius:6px; overflow:hidden; margin-right:1rem; }
    .confidence-fill { height:100%; border-radius:6px; background: linear-gradient(90deg,#8af65c,#37b910); transition: width 1s ease; }
    .form-group label { font-weight:600; display:block; margin-bottom:0.5rem; }
    .btn-group { display:flex; gap:1rem; margin-top:2rem; flex-wrap:wrap; }
    .status-badge { display:inline-block; padding:0.35rem 1rem; border-radius:2rem; font-weight:600; font-size:0.85rem; }
    .status-reviewed { background:#d1fada; color:#077531; }
    .status-pending { background:#fef3c7; color:#92400e; }
    .annotated-image img { max-width:250px; max-height:250px; border:1px solid #ccc; padding:5px; display:block; }
    @media (max-width:768px){ .info-grid{grid-template-columns:1fr;} .btn-group{flex-direction:column;} .btn-group a,.btn-group button{width:100%;} }
</style>
</head>
<body>

<div class="container">

    <!-- Header -->
    <div class="header-section">
        <h2>Review Report for {{ patient.get_full_name|default:patient.username }}</h2>
        <p><strong>Submitted on:</strong> {{ report.created_at|date:"M d, Y H:i" }}</p>
        <span class="status-badge {% if report.status == 'reviewed' %}status-reviewed{% else %}status-pending{% endif %}">
            {% if report.status == 'reviewed' %}Reviewed{% else %}Pending Review{% endif %}
        </span>
    </div>

    <!-- Report Card -->
    <div class="report-card">

        <!-- Annotated Image -->
        {% if report.annotated_image %}
            <div class="annotated-image mb-4">
                <h5>Annotated Image</h5>
                <img src="{{ report.annotated_image.url }}" alt="Annotated Skin Image">
            </div>
        {% elif progress and progress.annotated_image %}
            <div class="annotated-image mb-4">
                <h5>Annotated Image</h5>
                <img src="{{ progress.annotated_image.url }}" alt="Annotated Skin Image">
            </div>
        {% else %}
            <p><em>No annotated image available.</em></p>
        {% endif %}

        <!-- Detected Issues -->
        <div class="detection-box">
            <h5>Detected Issues</h5>
            <p>
                {% if filtered_issues %}
                    {{ filtered_issues|join:", " }}
                {% else %}
                    Awaiting Analysis
                {% endif %}
            </p>
        </div>

        <!-- AI Confidence & Patient Info -->
        <div class="info-grid">
            <div class="info-box">
                <h5>AI Confidence</h5>
                <div class="d-flex align-items-center">
                    <div class="confidence-bar">
                        <div class="confidence-fill" style="width: {{ report.confidence_scores|default:0 }}%;"></div>
                    </div>
                    <span>{{ report.confidence_scores|default:"0" }}%</span>
                </div>
            </div>

            <div class="info-box">
                <h5>Patient Name</h5>
                <p>{{ patient.get_full_name|default:patient.username }}</p>
            </div>

            <div class="info-box">
                <h5>Age</h5>
                <p>{{ patient.age|default:"—" }}</p>
            </div>

            <div class="info-box">
                <h5>Gender</h5>
                <p>{{ patient.gender|default:"—" }}</p>
            </div>

            <div class="info-box">
                <h5>Report Date</h5>
                <p>{{ report.created_at|date:"M d, Y" }}</p>
            </div>

            <div class="info-box">
                <h5>Report Time</h5>
                <p>{{ report.created_at|date:"H:i A" }}</p>
            </div>
        </div>

        <!-- Doctor Notes Form -->
        <form method="POST">
            {% csrf_token %}
            <div class="form-group mb-4">
                <label for="review_notes">Review Notes</label>
                <textarea name="review_notes" id="review_notes" rows="6" class="form-control" placeholder="Enter your clinical notes...">{{ report.review_notes }}</textarea>
            </div>

            <div class="form-group mb-4">
                <label for="status">Review Status</label>
                <select name="status" id="status" class="form-control">
                    <option value="reviewed" {% if report.status == 'reviewed' %}selected{% endif %}>Reviewed</option>
                    <option value="pending" {% if report.status == 'pending' %}selected{% endif %}>Pending</option>
                </select>
            </div>

            <div class="btn-group">
                <button type="submit" class="btn btn-primary">
                    {% if report.status == 'reviewed' %}Update Review{% else %}Submit Review{% endif %}
                </button>
                <a href="{% url 'doctor_pending_reports' %}" class="btn btn-secondary">Back to Reports</a>
            </div>
        </form>
    </div>

    <div class="text-center text-muted mt-4"><small>Report ID: {{ report.id }}</small></div>

</div>

</body>
</html>
